[{"name":"app.R","content":"library(shiny)\r\nlibrary(minpack.lm)\r\n\r\nui <- fluidPage(\r\n  \r\n  # Custom CSS for a slightly cleaner, flat look (optional but recommended)\r\n  tags$head(\r\n    tags$style(HTML(\"\r\n      /* Use a slightly different default font for readability */\r\n      body {\r\n        font-family: 'Open Sans', sans-serif;\r\n      }\r\n      /* Style for the main action button */\r\n      .btn-primary {\r\n        background-color: #2c3e50;\r\n        border-color: #2c3e50;\r\n        color: white;\r\n      }\r\n      .btn-primary:hover {\r\n        background-color: #1a242f;\r\n        border-color: #1a242f;\r\n      }\r\n      /* Style for the success button (Show Data) */\r\n      .btn-success {\r\n        background-color: #18bc9c;\r\n        border-color: #18bc9c;\r\n      }\r\n      .btn-success:hover {\r\n        background-color: #14a287;\r\n        border-color: #14a287;\r\n      }\r\n      /* Consistent look for well panels */\r\n      .well {\r\n        border-left: 5px solid #2c3e50;\r\n        background-color: #f8f8f8;\r\n        border-radius: 4px;\r\n        box-shadow: none;\r\n      }\r\n      /* Make tabs slightly more prominent */\r\n      .nav-pills > li.active > a, .nav-pills > li.active > a:hover, .nav-pills > li.active > a:focus {\r\n        background-color: #18bc9c;\r\n      }\r\n    \"))\r\n  ),\r\n  \r\n  titlePanel(\r\n    div(\r\n      span(\"Glycylglycine (GG) Kinetics Model\", style = \"font-weight: bold; color: #2c3e50;\"),\r\n      p(\"Hydrolysis & Cyclization\", style = \"font-size: 16px; margin-top: 5px; color = #7f8c8d;\")\r\n    ),\r\n    windowTitle = \"GG Kinetics Model\"\r\n  ),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      width = 4,\r\n      h4(\"1. Enter Your Data\", style = \"margin-bottom: 10px;\"),\r\n      helpText(\"Paste your experimental data here. Ensure columns are separated by tabs or commas.\"),\r\n      tags$textarea(\r\n        id = \"data_input\",\r\n        rows = 10,\r\n        cols = 50,\r\n        placeholder = \"time\\tGG\\tcGG\\tG\\n0\\t1.8428\\t0\\t0\\n2\\t1.6288\\t0.0708\\t0.4237\\n...\"\r\n      ),\r\n      \r\n      hr(),\r\n      h4(\"2. Model Options\", style = \"margin-top: 20px;\"),\r\n      \r\n      checkboxInput(\r\n        inputId = \"use_weights\",\r\n        label = \"Use robust weighting\",\r\n        value = TRUE\r\n      ),\r\n      helpText(\"This weights the fit to minimize the relative error, useful for data with varying magnitude.\"),\r\n      \r\n      hr(),\r\n      div(\r\n        actionButton(\"fit_btn\", \"Run Model & Analyze\", class = \"btn-primary\", icon = icon(\"dna\")),\r\n        # Button to show data in a dedicated tab\r\n        actionButton(\"show_data_btn\", \"Show Export Data (Copy Manually)\", class = \"btn-success\", icon = icon(\"table\"))\r\n      )\r\n    ),\r\n    \r\n    mainPanel(\r\n      width = 8,\r\n      tabsetPanel(\r\n        id = \"main_tabs\",\r\n        type = \"pills\",\r\n        \r\n        tabPanel(\"Kinetic Fit\",\r\n                 value = \"fit_tab\",\r\n                 h4(\"Kinetic Fit Overview\"),\r\n                 br(),\r\n                 fluidRow(\r\n                   column(6,\r\n                          wellPanel(\r\n                            h5(strong(\"Fitted Parameters\"), style = \"margin-top: 0;\"),\r\n                            verbatimTextOutput(\"fit_results\")\r\n                          )\r\n                   ),\r\n                   column(6,\r\n                          wellPanel(\r\n                            h5(strong(\"R-squared & Baselines\"), style = \"margin-top: 0;\"),\r\n                            verbatimTextOutput(\"metrics_results\")\r\n                          )\r\n                   )\r\n                 ),\r\n                 br(),\r\n                 plotOutput(\"fit_plot\", height = \"500px\"),\r\n                 hr(),\r\n                 h4(\"Residuals by Species\"),\r\n                 p(\"A good fit should show residuals scattered randomly around zero.\"),\r\n                 plotOutput(\"resid_plot\", height = \"400px\")\r\n        ),\r\n        \r\n        tabPanel(\"Glycine Fit\",\r\n                 h4(\"Alternative Glycine-Only Fit\"),\r\n                 p(\"Compares the full kinetic model (blue line) with a simplified, single-species fit (orange line) for the glycine data.\"),\r\n                 br(),\r\n                 fluidRow(\r\n                   column(6,\r\n                          wellPanel(\r\n                            h5(strong(\"Linear Fit Results\"), style = \"margin-top: 0;\"),\r\n                            verbatimTextOutput(\"g_fit_results\")\r\n                          )\r\n                   ),\r\n                   column(6,\r\n                          wellPanel(\r\n                            h5(strong(\"Model-Based Fit\"), style = \"margin-top: 0;\"),\r\n                            verbatimTextOutput(\"model_g_results\")\r\n                          )\r\n                   )\r\n                 ),\r\n                 plotOutput(\"g_fit_plot\", height = \"500px\")\r\n        ),\r\n        \r\n        # Tab for manual data export\r\n        tabPanel(\"Export Data\",\r\n                 value = \"export_data_tab\",\r\n                 h4(\"Data for Copy & Paste (Tab Separated)\"),\r\n                 helpText(strong(\"Instructions:\"), \"This file contains three sections: **1) Parameters**, **2) Raw Data + Fitted Values at Data Points**, and **3) High-Resolution Curves for Plotting** (Glycine only). Select all text below and manually copy (Ctrl+C / Cmd+C). Then paste (Ctrl+V / Cmd+V) directly into Excel, Google Sheets, or a CSV file editor.\"),\r\n                 verbatimTextOutput(\"raw_export_data\")\r\n        )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\nserver <- function(input, output, session) { \r\n  \r\n  # Reactive values to store all calculated data\r\n  results <- reactiveValues(\r\n    fit = NULL,\r\n    pars_est = NULL,\r\n    R2_global = NULL,\r\n    R2_by_species = NULL,\r\n    long_data = NULL,\r\n    exp_data = NULL,\r\n    g_fit_model = NULL,\r\n    model_g_pred = NULL,\r\n    data_export_text = NULL,\r\n    params_export_text = NULL,\r\n    glycine_plot_data_text = NULL # NEW: For high-res plotting data\r\n  )\r\n  \r\n  observeEvent(input$fit_btn, {\r\n    req(input$data_input)\r\n    \r\n    # --- Data parsing & checks ---\r\n    data_lines <- strsplit(input$data_input, \"\\n\")[[1]]\r\n    data_lines <- trimws(data_lines)\r\n    data_lines <- data_lines[data_lines != \"\"]\r\n    data_split <- lapply(data_lines, function(x) strsplit(x, \"\\t\")[[1]])\r\n    if (length(data_split) < 2) {\r\n      showNotification(\"Please include at least a header and one row of data.\", type = \"error\")\r\n      return()\r\n    }\r\n    col_names <- data_split[[1]]\r\n    data_matrix <- data_split[-1]\r\n    data_matrix <- data_matrix[sapply(data_matrix, length) == length(col_names)]\r\n    if (length(data_matrix) == 0) {\r\n      showNotification(\"No valid data rows found. Check formatting.\", type = \"error\")\r\n      return()\r\n    }\r\n    df <- as.data.frame(do.call(rbind, data_matrix), stringsAsFactors = FALSE)\r\n    colnames(df) <- col_names\r\n    df[] <- lapply(df, function(col) as.numeric(gsub(\",\", \".\", col)))\r\n    if (anyNA(df)) {\r\n      showNotification(\"Some values could not be converted to numbers. Check input.\", type = \"error\")\r\n      return()\r\n    }\r\n    \r\n    exp_data <- df[order(df$time), ] \r\n    n <- nrow(exp_data)\r\n    results$exp_data <- exp_data\r\n    \r\n    long_data <- data.frame(\r\n      time = rep(exp_data$time, 3),\r\n      conc = c(exp_data$GG, exp_data$cGG, exp_data$G),\r\n      species = factor(rep(c(\"GG\", \"cGG\", \"G\"), each = n)) \r\n    )\r\n    results$long_data <- long_data\r\n    \r\n    use_weights <- isTRUE(input$use_weights)\r\n    small <- 1e-6\r\n    obs_w <- if (use_weights) 1 / sqrt(pmax(long_data$conc, small)) else rep(1, nrow(long_data))\r\n    \r\n    # --- Model function & fitting (kinetic) ---\r\n    model_fun_pars <- function(pars, time, species) {\r\n      GG0 <- exp(pars[\"logGG0\"])\r\n      k1 <- exp(pars[\"logk1\"])\r\n      k2 <- exp(pars[\"logk2\"])\r\n      ksum <- k1 + k2\r\n      GG_pred <- GG0 * exp(-ksum * time)\r\n      cGG_pred <- GG0 * k2 / ksum * (1 - exp(-ksum * time))\r\n      G_pred <- 2 * GG0 * k1 / ksum * (1 - exp(-ksum * time))\r\n      cGG_pred <- cGG_pred + pars[\"bg_cGG\"]\r\n      G_pred <- G_pred + pars[\"bg_G\"]\r\n      ifelse(species == \"GG\", GG_pred, ifelse(species == \"cGG\", cGG_pred, G_pred))\r\n    }\r\n    \r\n    resid_fun <- function(pars, time, species, conc, w) {\r\n      pred <- model_fun_pars(pars, time, species)\r\n      (pred - conc) * w\r\n    }\r\n    \r\n    GG0_start <- max(exp_data$GG, na.rm = TRUE)\r\n    t_span <- max(exp_data$time) - min(exp_data$time)\r\n    k_guess <- if (t_span > 0) log(2) / max(1, t_span) else 0.1\r\n    \r\n    start_pars <- c(\r\n      logGG0 = log(ifelse(GG0_start > 0, GG0_start, 0.5)),\r\n      logk1 = log(max(1e-3, k_guess * 0.5)),\r\n      logk2 = log(max(1e-3, k_guess * 0.2)),\r\n      bg_cGG = min(exp_data$cGG, na.rm = TRUE) * 0.5,\r\n      bg_G = min(exp_data$G, na.rm = TRUE) * 0.5\r\n    )\r\n    start_vec <- as.numeric(start_pars)\r\n    names(start_vec) <- names(start_pars)\r\n    \r\n    fit <- tryCatch(\r\n      nls.lm(\r\n        par = start_vec, fn = resid_fun, time = long_data$time, species = long_data$species,\r\n        conc = long_data$conc, w = obs_w, control = nls.lm.control(maxiter = 200, ftol = 1e-10)\r\n      ),\r\n      error = function(e) e\r\n    )\r\n    \r\n    if (inherits(fit, \"error\")) {\r\n      showNotification(paste(\"Fit failed:\", fit$message), type = \"error\", duration = 8)\r\n      results$fit <- \"fail\"\r\n      return()\r\n    }\r\n    \r\n    results$fit <- fit\r\n    results$pars_est <- fit$par\r\n    \r\n    long_data$predicted <- model_fun_pars(results$pars_est, long_data$time, long_data$species)\r\n    long_data$resid <- long_data$conc - long_data$predicted\r\n    results$long_data <- long_data\r\n    \r\n    ss_res_global <- sum((long_data$conc - long_data$predicted)^2)\r\n    ss_tot_global <- sum((long_data$conc - mean(long_data$conc))^2)\r\n    results$R2_global <- 1 - ss_res_global / ss_tot_global\r\n    \r\n    R2_by_species_list <- by(long_data, long_data$species, function(subset_df) {\r\n      ss_res <- sum((subset_df$conc - subset_df$predicted)^2)\r\n      ss_tot <- sum((subset_df$conc - mean(subset_df$conc))^2)\r\n      R2 <- ifelse(ss_tot > 0, 1 - ss_res / ss_tot, NA_real_)\r\n      data.frame(species = subset_df$species[1], R2 = R2)\r\n    })\r\n    results$R2_by_species <- do.call(rbind, R2_by_species_list)\r\n    \r\n    # --- Glycine Fit Calculations & R2s ---\r\n    g_data <- exp_data[, c(\"time\", \"G\")]\r\n    g_fit_model_success <- FALSE\r\n    \r\n    # 1. Linear Glycine Fit\r\n    tryCatch({\r\n      t_half_guess <- g_data$time[which.min(abs(g_data$G - max(g_data$G) / 2))]\r\n      k_app_guess <- if(length(t_half_guess) > 0 && is.finite(t_half_guess) && t_half_guess > 0) log(2) / t_half_guess else 0.05\r\n      g_fit_model <- nlsLM(\r\n        G ~ G_inf * (1 - exp(-k_app * time)),\r\n        data = g_data,\r\n        start = list(G_inf = max(g_data$G), k_app = k_app_guess),\r\n        lower = c(0, 0),\r\n        upper = c(Inf, Inf)\r\n      )\r\n      results$g_fit_model <- g_fit_model\r\n      g_fit_model_success <- TRUE\r\n      \r\n      # Calculate R2 for Linear Glycine Fit\r\n      g_pred <- predict(results$g_fit_model, g_data)\r\n      ss_res_g_lin <- sum((g_data$G - g_pred)^2)\r\n      ss_tot_g <- sum((g_data$G - mean(g_data$G))^2) # Need ss_tot_g for R2_model_g later\r\n      R2_g_lin <- 1 - ss_res_g_lin / ss_tot_g\r\n      \r\n    }, error = function(e) {\r\n      results$g_fit_model <- \"fail\"\r\n      ss_tot_g <- sum((g_data$G - mean(g_data$G))^2)\r\n      R2_g_lin <- NA_real_\r\n    })\r\n    \r\n    # 2. Model-based G predictions (at experimental points)\r\n    pars_est <- results$pars_est\r\n    GG0_fit <- exp(pars_est[\"logGG0\"])\r\n    k1_fit <- exp(pars_est[\"logk1\"])\r\n    k2_fit <- exp(pars_est[\"logk2\"])\r\n    ksum_fit <- k1_fit + k2_fit\r\n    bg_G_fit <- pars_est[\"bg_G\"]\r\n    \r\n    G_model_pred_exp <- 2 * GG0_fit * k1_fit / ksum_fit * (1 - exp(-ksum_fit * g_data$time)) + pars_est[\"bg_G\"]\r\n    ss_res_model <- sum((g_data$G - G_model_pred_exp)^2)\r\n    R2_model_g <- 1 - ss_res_model / ss_tot_g\r\n    \r\n    \r\n    # --- Data Export Preparation (3 Sections) ---\r\n    \r\n    # --- Section 1: Parameters (Kinetic + Glycine) ---\r\n    param_names <- c(\r\n      \"Initial_GG_GG0_mM\", \"k1_hydrolysis_h-1\", \"k2_cyclization_h-1\", \"k_sum_h-1\", \r\n      \"t_half_total_h\", \"t_half_k1_h\", \"t_half_k2_h\", \r\n      \"Global_R2\", \"R2_GG\", \"R2_cGG\", \"R2_G\", \r\n      \"Baseline_cGG_mM\", \"Baseline_G_mM\",\r\n      \"R2_Glycine_Model_Fit\"\r\n    )\r\n    param_values <- c(\r\n      GG0_fit, k1_fit, k2_fit, ksum_fit, \r\n      log(2) / ksum_fit, log(2) / k1_fit, log(2) / k2_fit, \r\n      results$R2_global, results$R2_by_species$R2[1], results$R2_by_species$R2[2], results$R2_by_species$R2[3], \r\n      pars_est[\"bg_cGG\"], pars_est[\"bg_G\"],\r\n      R2_model_g\r\n    )\r\n    \r\n    if (g_fit_model_success) {\r\n      coefs <- coef(results$g_fit_model)\r\n      param_names <- c(param_names, \r\n                       \"Glycine_Linear_Fit_k_app_h-1\", \"Glycine_Linear_Fit_G_inf_mM\", \"R2_Glycine_Linear_Fit\"\r\n      )\r\n      param_values <- c(param_values, \r\n                        coefs[\"k_app\"], coefs[\"G_inf\"], R2_g_lin\r\n      )\r\n    } else {\r\n      param_names <- c(param_names, \r\n                       \"Glycine_Linear_Fit_k_app_h-1\", \"Glycine_Linear_Fit_G_inf_mM\", \"R2_Glycine_Linear_Fit\"\r\n      )\r\n      param_values <- c(param_values, \r\n                        NA, NA, NA\r\n      )\r\n    }\r\n    \r\n    export_params_df <- data.frame(Parameter = param_names, Value = param_values)\r\n    \r\n    # Convert parameter data frame to tab-separated string with a header\r\n    params_header <- \"#--- Section 1: Fitted Kinetic Parameters and Model Metrics ---\"\r\n    params_string <- paste(\r\n      utils::capture.output(\r\n        write.table(export_params_df, sep = \"\\t\", row.names = FALSE, quote = FALSE)\r\n      ), \r\n      collapse = \"\\n\"\r\n    )\r\n    results$params_export_text <- paste(params_header, params_string, sep = \"\\n\")\r\n    \r\n    \r\n    # --- Section 2: Raw Data and Fitted Data at Experimental Time Points ---\r\n    export_df <- results$exp_data\r\n    export_df$GG_fit <- GG0_fit * exp(-ksum_fit * export_df$time)\r\n    export_df$cGG_fit <- GG0_fit * k2_fit / ksum_fit * (1 - exp(-ksum_fit * export_df$time)) + pars_est[\"bg_cGG\"]\r\n    export_df$G_fit <- 2 * GG0_fit * k1_fit / ksum_fit * (1 - exp(-ksum_fit * export_df$time)) + pars_est[\"bg_G\"]\r\n    \r\n    data_header <- \"\\n\\n#--- Section 2: Raw Data and Fitted Values (at experimental time points) ---\"\r\n    data_string <- paste(\r\n      utils::capture.output(\r\n        write.table(export_df, sep = \"\\t\", row.names = FALSE, quote = FALSE)\r\n      ), \r\n      collapse = \"\\n\"\r\n    )\r\n    results$data_export_text <- paste(data_header, data_string, sep = \"\\n\")\r\n    \r\n    \r\n    # --- Section 3: High-Resolution Glycine Plotting Data (NEW) ---\r\n    t_plot <- seq(min(exp_data$time), max(exp_data$time), length.out = 200)\r\n    glycine_plot_df <- data.frame(time = t_plot)\r\n    \r\n    # Model-based G curve\r\n    glycine_plot_df$G_Model_Curve <- 2 * GG0_fit * k1_fit / ksum_fit * (1 - exp(-ksum_fit * t_plot)) + bg_G_fit\r\n    \r\n    # Linear Fit G curve\r\n    if (g_fit_model_success) {\r\n      coefs <- coef(results$g_fit_model)\r\n      glycine_plot_df$G_Linear_Curve <- coefs[\"G_inf\"] * (1 - exp(-coefs[\"k_app\"] * t_plot))\r\n    } else {\r\n      glycine_plot_df$G_Linear_Curve <- NA_real_\r\n    }\r\n    \r\n    glycine_plot_header <- \"\\n\\n#--- Section 3: High-Resolution Fitted Curves for Glycine Plotting ---\"\r\n    glycine_plot_string <- paste(\r\n      utils::capture.output(\r\n        write.table(glycine_plot_df, sep = \"\\t\", row.names = FALSE, quote = FALSE)\r\n      ), \r\n      collapse = \"\\n\"\r\n    )\r\n    results$glycine_plot_data_text <- paste(glycine_plot_header, glycine_plot_string, sep = \"\\n\")\r\n    # ------------------------------------------------------------------\r\n  })\r\n  \r\n  # --- Observer to handle the Show Export Data button press ---\r\n  observeEvent(input$show_data_btn, {\r\n    req(results$data_export_text)\r\n    \r\n    # Switch to the 'Export Data' tab\r\n    updateTabsetPanel(session, \"main_tabs\", selected = \"export_data_tab\")\r\n    \r\n    # Show a notification\r\n    showNotification(\"Select the text in the table below and copy manually.\", type = \"message\", duration = 8)\r\n  })\r\n  \r\n  # --- Renderer for the raw export data (Combines all three sections) ---\r\n  output$raw_export_data <- renderPrint({\r\n    req(results$params_export_text, results$data_export_text, results$glycine_plot_data_text)\r\n    \r\n    # Combine parameters, experimental data, and plotting curves\r\n    cat(results$params_export_text, results$data_export_text, results$glycine_plot_data_text, sep = \"\\n\")\r\n  })\r\n  \r\n  # --- All other renderOutputs (fit_results, metrics_results, plots, etc.) remain unchanged for brevity. ---\r\n  \r\n  output$fit_results <- renderPrint({\r\n    req(results$pars_est)\r\n    \r\n    if (is.character(results$fit) && results$fit == \"fail\") {\r\n      cat(\"Model fit failed. Please check your data.\\n\")\r\n      return()\r\n    }\r\n    \r\n    pars_est <- results$pars_est\r\n    GG0_fit <- exp(pars_est[\"logGG0\"])\r\n    k1_fit <- exp(pars_est[\"logk1\"])\r\n    k2_fit <- exp(pars_est[\"logk2\"])\r\n    ksum_fit <- k1_fit + k2_fit \r\n    \r\n    cat(\"Fitted Parameters\\n\")\r\n    cat(sprintf(\"GG0 = %.4f mM\\n\", GG0_fit))\r\n    cat(sprintf(\"k1 (hydrolysis) = %.4f h^-1\\n\", k1_fit))\r\n    cat(sprintf(\"k2 (cyclization) = %.4f h^-1\\n\", k2_fit))\r\n    cat(sprintf(\"k_sum = %.4f h^-1\\n\", ksum_fit))\r\n    \r\n    cat(\"\\nHalf-lives:\\n\")\r\n    cat(sprintf(\"Total (1/(k1+k2)) t1/2 = %.2f h\\n\", log(2) / ksum_fit))\r\n    cat(sprintf(\"Hydrolysis alone t1/2 = %.2f h\\n\", log(2) / k1_fit))\r\n    cat(sprintf(\"Cyclization alone t1/2 = %.2f h\\n\", log(2) / k2_fit))\r\n  })\r\n  \r\n  output$metrics_results <- renderPrint({\r\n    req(results$R2_global)\r\n    \r\n    if (is.character(results$fit) && results$fit == \"fail\") {\r\n      return()\r\n    }\r\n    \r\n    cat(\"Goodness of Fit\\n\")\r\n    cat(sprintf(\"Global R² = %.4f\\n\", results$R2_global))\r\n    cat(\"\\nPer-species R²:\\n\")\r\n    print(results$R2_by_species)\r\n    \r\n    pars_est <- results$pars_est\r\n    cat(\"\\nFitted Baselines:\\n\")\r\n    cat(sprintf(\"bg_cGG = %.4f mM\\n\", pars_est[\"bg_cGG\"]))\r\n    cat(sprintf(\"bg_G = %.4f mM\\n\", pars_est[\"bg_G\"]))\r\n  })\r\n  \r\n  output$fit_plot <- renderPlot({\r\n    req(results$long_data, results$pars_est)\r\n    \r\n    if (is.character(results$fit) && results$fit == \"fail\") {\r\n      plot(1, type = \"n\", axes = FALSE, xlab = \"\", ylab = \"\", main = \"Model fit failed. Plot not available.\")\r\n      return()\r\n    }\r\n    \r\n    pars_est <- results$pars_est\r\n    GG0_fit <- exp(pars_est[\"logGG0\"])\r\n    k1_fit <- exp(pars_est[\"logk1\"])\r\n    k2_fit <- exp(pars_est[\"logk2\"])\r\n    ksum_fit <- k1_fit + k2_fit \r\n    bg_cGG_fit <- pars_est[\"bg_cGG\"]\r\n    bg_G_fit <- pars_est[\"bg_G\"]\r\n    \r\n    t_fit <- seq(min(results$exp_data$time), max(results$exp_data$time), length.out = 300)\r\n    \r\n    fit_GG <- GG0_fit * exp(-ksum_fit * t_fit)\r\n    fit_cGG <- GG0_fit * k2_fit / ksum_fit * (1 - exp(-ksum_fit * t_fit)) + bg_cGG_fit\r\n    fit_G <- 2 * GG0_fit * k1_fit / ksum_fit * (1 - exp(-ksum_fit * t_fit)) + bg_G_fit\r\n    \r\n    # Base R Plotting\r\n    cols <- c(\"#1f78b4\", \"#e31a1c\", \"#33a02c\") # GG, cGG, G colors\r\n    \r\n    # Set up plot limits\r\n    y_range <- range(results$long_data$conc, fit_GG, fit_cGG, fit_G, na.rm = TRUE)\r\n    \r\n    plot(NA, xlim = range(results$long_data$time), ylim = y_range,\r\n         xlab = \"Time (h)\", ylab = \"Concentration (mM)\",\r\n         main = \"Kinetic Model Fit (Base R Graphics)\", type = \"n\",\r\n         cex.main = 1.2, font.main = 2)\r\n    \r\n    # Add fit lines\r\n    lines(t_fit, fit_GG, col = cols[1], lwd = 2)\r\n    lines(t_fit, fit_cGG, col = cols[2], lwd = 2)\r\n    lines(t_fit, fit_G, col = cols[3], lwd = 2)\r\n    \r\n    # Add data points\r\n    points(results$exp_data$time, results$exp_data$GG, col = cols[1], pch = 16, cex = 1.5)\r\n    points(results$exp_data$time, results$exp_data$cGG, col = cols[2], pch = 16, cex = 1.5)\r\n    points(results$exp_data$time, results$exp_data$G, col = cols[3], pch = 16, cex = 1.5)\r\n    \r\n    # Add legend\r\n    legend(\"topright\", \r\n           legend = c(\"GG (data)\", \"cGG (data)\", \"G (data)\", \"GG (fit)\", \"cGG (fit)\", \"G (fit)\"),\r\n           col = c(cols, cols),\r\n           pch = c(16, 16, 16, NA, NA, NA),\r\n           lty = c(NA, NA, NA, 1, 1, 1),\r\n           lwd = c(NA, NA, NA, 2, 2, 2),\r\n           cex = 1)\r\n  })\r\n  \r\n  output$resid_plot <- renderPlot({\r\n    req(results$long_data)\r\n    \r\n    if (is.character(results$fit) && results$fit == \"fail\") {\r\n      plot(1, type = \"n\", axes = FALSE, xlab = \"\", ylab = \"\", main = \"Model fit failed. Plot not available.\")\r\n      return()\r\n    }\r\n    \r\n    rd <- results$long_data\r\n    species_levels <- levels(rd$species)\r\n    cols <- c(\"#1f78b4\", \"#e31a1c\", \"#33a02c\")\r\n    \r\n    # Base R multi-panel plot\r\n    par(mfrow = c(1, length(species_levels)), mar = c(4, 4, 3, 1))\r\n    \r\n    for (i in seq_along(species_levels)) {\r\n      species_data <- rd[rd$species == species_levels[i], ]\r\n      \r\n      plot(species_data$time, species_data$resid,\r\n           xlab = \"Time (h)\", ylab = \"Residual (mM)\",\r\n           main = paste(\"Residuals for\", species_levels[i]),\r\n           col = cols[i], pch = 16, \r\n           cex.main = 1, cex.lab = 1,\r\n           ylim = range(rd$resid)) \r\n      \r\n      # Add the zero line\r\n      abline(h = 0, lty = 2, col = \"gray\")\r\n    }\r\n    \r\n    # Reset plotting layout\r\n    par(mfrow = c(1, 1), mar = c(5, 4, 4, 2) + 0.1)\r\n  })\r\n  \r\n  output$g_fit_results <- renderPrint({\r\n    if (is.character(results$g_fit_model) && results$g_fit_model == \"fail\") {\r\n      cat(\"⚠️ Linear Glycine fit failed.\\n\")\r\n      cat(\"Tip: Data may not follow simple exponential rise.\")\r\n      return()\r\n    }\r\n    \r\n    coefs <- coef(results$g_fit_model)\r\n    cat(\"Linear Glycine Fit (apparent kinetics):\\n\")\r\n    cat(sprintf(\"k_app = %.4f h^-1\\n\", coefs[\"k_app\"]))\r\n    cat(sprintf(\"t1/2 = %.2f h\\n\", log(2) / coefs[\"k_app\"]))\r\n    cat(sprintf(\"G_inf = %.2f mM\\n\", coefs[\"G_inf\"]))\r\n    \r\n    g_data <- results$exp_data[, c(\"time\", \"G\")]\r\n    g_pred <- predict(results$g_fit_model, g_data)\r\n    ss_res <- sum((g_data$G - g_pred)^2)\r\n    ss_tot <- sum((g_data$G - mean(g_data$G))^2)\r\n    R2_g <- 1 - ss_res / ss_tot\r\n    cat(sprintf(\"R² = %.4f\\n\", R2_g))\r\n  })\r\n  \r\n  output$model_g_results <- renderPrint({\r\n    req(results$pars_est, results$exp_data)\r\n    \r\n    if (is.character(results$fit) && results$fit == \"fail\") {\r\n      cat(\"⚠️ Model-based Glycine predictions not available due to main model fit failure.\\n\")\r\n      return()\r\n    }\r\n    \r\n    pars_est <- results$pars_est\r\n    GG0_fit <- exp(pars_est[\"logGG0\"])\r\n    k1_fit <- exp(pars_est[\"logk1\"])\r\n    k2_fit <- exp(pars_est[\"logk2\"])\r\n    ksum_fit <- k1_fit + k2_fit \r\n    \r\n    cat(\"Model-Based Glycine Predictions:\\n\")\r\n    cat(sprintf(\"k_sum (k1+k2) = %.4f h^-1\\n\", ksum_fit))\r\n    cat(sprintf(\"G_inf (as 2*GG0*k1/k_sum) = %.4f mM\\n\", 2 * GG0_fit * k1_fit / ksum_fit))\r\n    \r\n    g_data <- results$exp_data[, c(\"time\", \"G\")]\r\n    G_model_pred <- 2 * GG0_fit * k1_fit / ksum_fit * (1 - exp(-ksum_fit * g_data$time)) + pars_est[\"bg_G\"]\r\n    ss_res_model <- sum((g_data$G - G_model_pred)^2)\r\n    ss_tot_g <- sum((g_data$G - mean(g_data$G))^2)\r\n    R2_model_g <- 1 - ss_res_model / ss_tot_g\r\n    cat(sprintf(\"R² = %.4f\\n\", R2_model_g))\r\n  })\r\n  \r\n  output$g_fit_plot <- renderPlot({\r\n    req(results$exp_data, results$glycine_plot_data_text) # Req the high-res data here\r\n    \r\n    g_data <- results$exp_data[, c(\"time\", \"G\")]\r\n    t_vals <- seq(min(g_data$time), max(g_data$time), length.out = 200)\r\n    \r\n    # Extract the high-res data used for export\r\n    # NOTE: In a true shiny app, you would use the reactive `results$glycine_plot_df` if it were stored.\r\n    # Since we only store the text string for export, we'll re-run the calculation or rely on the t_vals vector.\r\n    \r\n    # Recalculate/use existing for plot clarity:\r\n    G_model_pred <- results$model_g_pred\r\n    \r\n    # Base R Plot Setup\r\n    plot(g_data$time, g_data$G,\r\n         xlab = \"Time (h)\", ylab = \"Glycine (mM)\",\r\n         main = \"Glycine Fit Comparison\",\r\n         col = \"#33a02c\", pch = 16, cex = 1.5,\r\n         ylim = range(0, g_data$G, G_model_pred, na.rm = TRUE))\r\n    \r\n    # Add linear fit line if model is available\r\n    if (!(is.character(results$g_fit_model) && results$g_fit_model == \"fail\")) {\r\n      coefs <- coef(results$g_fit_model)\r\n      g_lin_pred <- coefs[\"G_inf\"] * (1 - exp(-coefs[\"k_app\"] * t_vals))\r\n      lines(t_vals, g_lin_pred, col = \"#e31a1c\", lwd = 2, lty = 2) # Dashed line for linear fit\r\n    }\r\n    \r\n    # Add model-based fit line if main fit is successful\r\n    if (!(is.character(results$fit) && results$fit == \"fail\")) {\r\n      lines(t_vals, G_model_pred, col = \"#1f78b4\", lwd = 2, lty = 1) # Solid line for model fit\r\n    }\r\n    \r\n    # Add Legend\r\n    legend_text <- c(\"Data\")\r\n    legend_col <- c(\"#33a02c\")\r\n    legend_pch <- c(16)\r\n    legend_lty <- c(NA)\r\n    legend_lwd <- c(NA)\r\n    \r\n    if (!(is.character(results$g_fit_model) && results$g_fit_model == \"fail\")) {\r\n      legend_text <- c(legend_text, \"Linear Fit\")\r\n      legend_col <- c(legend_col, \"#e31a1c\")\r\n      legend_pch <- c(legend_pch, NA)\r\n      legend_lty <- c(legend_lty, 2)\r\n      legend_lwd <- c(legend_lwd, 2)\r\n    }\r\n    \r\n    if (!(is.character(results$fit) && results$fit == \"fail\")) {\r\n      legend_text <- c(legend_text, \"Model Fit\")\r\n      legend_col <- c(legend_col, \"#1f78b4\")\r\n      legend_pch <- c(legend_pch, NA)\r\n      legend_lty <- c(legend_lty, 1)\r\n      legend_lwd <- c(legend_lwd, 2)\r\n    }\r\n    \r\n    legend(\"bottomright\", \r\n           legend = legend_text,\r\n           col = legend_col,\r\n           pch = legend_pch,\r\n           lty = legend_lty,\r\n           lwd = legend_lwd,\r\n           cex = 1)\r\n  })\r\n  \r\n  output$download_csv <- downloadHandler(\r\n    filename = function() paste0(\"GG_kinetic_fit_\", Sys.Date(), \".csv\"),\r\n    content = function(file) {\r\n      showNotification(\"Download functionality is replaced by the 'Show Export Data' button.\", type = \"warning\")\r\n      return(NULL)\r\n    }\r\n  )\r\n}\r\n\r\nshinyApp(ui = ui, server = server)","type":"text"}]
